# Go 的并发调度：MPG模型

<!--more-->
#

## 基本概念

M-P-G 分别代表什么？
- [M]^(Machine)：传统意义上的**线程**，work thread
- [P]^(Processor)：认为抽象的**处理器**
- [G]^(Goroutine)：**协程**

### 工作线程

假设工作线程总是贪心的执行每个 G，那么可能存在下面两种情况：
1. G 的数量 > 本地线程的数量
![](images/posts/Pasted%20image%2020230518140324.png)
2. G 的数量 < 本地线程的数量
![](images/posts/Pasted%20image%2020230518140400.png)


## 一个简单的工作流程

在 MPG 并发模型中，调度器（Scheduler）负责管理和调度工作线程（Worker Thread），以实现协程的并发执行。MPG 调度的过程如下：

1.  初始化：在程序启动时，调度器会初始化一个工作线程池，并将其中的每个工作线程标记为空闲状态。
    
2.  协程创建：当一个协程被创建时，调度器会将该协程加入到协程队列中，并等待调度执行。
    
3.  工作线程选择：当一个协程需要执行时，调度器会从工作线程池中选择一个空闲的工作线程，并将该协程绑定到该工作线程上。
    
4.  协程执行：当一个协程被绑定到工作线程上后，该协程就可以开始执行了。如果该协程需要暂停或者等待 I/O 操作完成，则调度器会将该协程的状态设置为暂停状态，并将该协程所绑定的工作线程标记为空闲状态。
    
5.  工作线程空闲：当一个工作线程执行完毕或者暂停时，调度器会将该工作线程标记为空闲状态，并等待下一个协程的调度。
    
6.  协程恢复执行：当一个协程需要继续执行时，调度器会重新选择一个空闲的工作线程，并将该协程绑定到该工作线程上，从而实现协程的恢复执行。
    

通过合理地管理和调度工作线程，MPG 并发模型可以充分利用计算机资源，提高程序的性能和响应能力。同时，为了保证并发的正确性和安全性，还需要使用锁、信号量、互斥量等机制来控制对共享资源的访问

---
1. https://golang.design/under-the-hood/zh-cn/part2runtime/ch06sched/mpg/
